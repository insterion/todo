<!DOCTYPE html>
<html lang="bg" style="color-scheme: dark;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner Pro</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { 
            --primary: #BB86FC; 
            --bg: #000000; 
            --card: #1c1c1e; 
            --text: #ffffff; 
            --accent: #03dac6; 
            --gray: #2c2c2e;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            padding-bottom: 90px; /* –ú—è—Å—Ç–æ –∑–∞ –±—É—Ç–æ–Ω–∞ */
        }
        
        /* –ó–∞–≥–ª–∞–≤–∏–µ */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; font-weight: 700; font-size: 24px; background: linear-gradient(90deg, #BB86FC, #03dac6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* –°–µ–∫—Ü–∏–∏ */
        .section-title { font-size: 0.85em; color: #888; margin-top: 25px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* –ö–∞—Ä—Ç–∏ */
        .task-card {
            background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 16px;
            display: flex; align-items: center; border-left: 4px solid var(--accent);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .task-card:active { transform: scale(0.98); }
        .task-card.overdue { border-left-color: #ff453a; } /* –ß–µ—Ä–≤–µ–Ω–æ –∑–∞ –ø—Ä–æ–ø—É—Å–Ω–∞—Ç–∏ */
        .task-card.future { border-left-color: #555; opacity: 0.7; }

        .check-circle {
            min-width: 26px; height: 26px; border: 2px solid var(--accent); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        
        .info { flex-grow: 1; overflow: hidden; }
        .text { font-size: 1.1em; font-weight: 500; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .meta { font-size: 0.85em; color: #aaa; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        
        .tag { background: #333; padding: 2px 8px; border-radius: 6px; font-size: 0.85em; display: flex; align-items: center; gap: 4px; }
        .tag-end { color: #ff9f0a; } /* –û—Ä–∞–Ω–∂–µ–≤–æ –∑–∞ –∫—Ä–∞–µ–Ω —Å—Ä–æ–∫ */

        .btn-del { background: none; border: none; font-size: 1.2em; color: #666; padding: 10px; cursor: pointer; }

        /* FAB (–ü–ª–∞–≤–∞—â –±—É—Ç–æ–Ω) */
        .fab {
            position: fixed; bottom: 25px; right: 25px; width: 64px; height: 64px;
            background: var(--primary); color: #000; border-radius: 50%; border: none;
            font-size: 32px; box-shadow: 0 4px 20px rgba(187, 134, 252, 0.4); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 100;
        }

        /* –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 200;
        }
        .modal {
            background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.9em; }
        
        input, select {
            width: 100%; padding: 14px; background: var(--gray); border: 1px solid #3a3a3c;
            color: white; border-radius: 10px; box-sizing: border-box; font-size: 16px; outline: none;
        }
        input:focus { border-color: var(--primary); }

        .row { display: flex; gap: 10px; }
        
        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px; }
        .btn-save { background: var(--primary); color: #000; padding: 12px 24px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; }
        .btn-cancel { background: transparent; color: #aaa; padding: 12px 20px; border: none; font-size: 16px; }
        
        #customDaysRow, #endDateRow { display: none; }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è */
        @keyframes pop { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal { animation: pop 0.2s ease-out; }
    </style>
</head>
<body>

    <header>
        <h2>Smart Planner</h2>
    </header>

    <div id="app"></div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 style="margin-top:0; color:white;">–ù–æ–≤–∞ –ó–∞–¥–∞—á–∞</h3>
            
            <div class="form-group">
                <input type="text" id="inpDesc" placeholder="–ù–∞–ø–∏—à–∏ –∑–∞–≥–ª–∞–≤–∏–µ...">
            </div>
            
            <div class="row form-group">
                <div style="flex:1">
                    <label>–ù–∞—á–∞–ª–æ:</label>
                    <input type="date" id="inpDate">
                </div>
                <div style="flex:0.6">
                    <label>–ß–∞—Å:</label>
                    <input type="time" id="inpTime">
                </div>
            </div>

            <div class="form-group">
                <label>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ:</label>
                <select id="inpRepeat" onchange="handleRepeatChange()">
                    <option value="none">–ï–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ</option>
                    <option value="daily">–í—Å–µ–∫–∏ –¥–µ–Ω</option>
                    <option value="weekly">–í—Å—è–∫–∞ —Å–µ–¥–º–∏—Ü–∞</option>
                    <option value="custom">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–æ (–Ω–∞ –¥–Ω–∏)</option>
                </select>
            </div>

            <div class="form-group" id="customDaysRow">
                <label>–ù–∞ –≤—Å–µ–∫–∏ –∫–æ–ª–∫–æ –¥–Ω–∏?</label>
                <input type="number" id="inpDays" value="5">
            </div>
            
            <div class="form-group" id="endDateRow">
                <label>–°–ø—Ä–∏ –ø–æ–≤—Ç–∞—Ä—è–Ω–µ—Ç–æ —Å–ª–µ–¥ (–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫):</label>
                <input type="date" id="inpEndDate" style="border-color: #ff9f0a;">
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">–û—Ç–∫–∞–∑</button>
                <button class="btn-save" onclick="saveTask()">–ó–∞–ø–∞–∑–∏</button>
            </div>
        </div>
    </div>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        // --- 1. CONFIG ---
        let tasks = JSON.parse(localStorage.getItem('tasksV5')) || [];
        
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–Ω–µ –Ω–∞ Service Worker
        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        Notification.requestPermission();
        
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('inpDate').value = todayStr;

        render();
        setInterval(checkReminders, 5000);

        // --- 2. LOGIC ---

        function saveTask() {
            const desc = document.getElementById('inpDesc').value;
            const date = document.getElementById('inpDate').value || todayStr;
            const time = document.getElementById('inpTime').value;
            const repeatType = document.getElementById('inpRepeat').value;
            const customDays = document.getElementById('inpDays').value;
            const endDate = document.getElementById('inpEndDate').value; // –ù–æ–≤–∞—Ç–∞ –∫—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞

            if(!desc) return alert("–ú–æ–ª—è –Ω–∞–ø–∏—à–∏ –∑–∞–≥–ª–∞–≤–∏–µ!");

            const newTask = {
                id: Date.now(),
                desc,
                date,
                time, 
                repeat: repeatType,
                customInterval: (repeatType === 'custom') ? parseInt(customDays) : 0,
                endDate: endDate || null, // –ó–∞–ø–∞–∑–≤–∞–º–µ –∫—Ä–∞–π–Ω–∞—Ç–∞ –¥–∞—Ç–∞
                notified: false
            };

            tasks.push(newTask);
            saveData();
            closeModal();
            render();
        }

        function completeTask(id) {
            const index = tasks.findIndex(t => t.id === id);
            if (index === -1) return;
            const task = tasks[index];

            // –ê–∫–æ –µ –µ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞ - —Ç—Ä–∏–µ–º –≤–µ–¥–Ω–∞–≥–∞
            if (task.repeat === 'none') {
                tasks.splice(index, 1);
                saveData(); render();
                return;
            }

            // –ò–Ω–∞—á–µ –∏–∑—á–∏—Å–ª—è–≤–∞–º–µ —Å–ª–µ–¥–≤–∞—â–∞—Ç–∞ –¥–∞—Ç–∞
            const currentObj = new Date(task.date);
            let nextDate = new Date(currentObj);

            if (task.repeat === 'daily') nextDate.setDate(currentObj.getDate() + 1);
            else if (task.repeat === 'weekly') nextDate.setDate(currentObj.getDate() + 7);
            else if (task.repeat === 'custom') nextDate.setDate(currentObj.getDate() + task.customInterval);

            const nextDateStr = nextDate.toISOString().split('T')[0];

            // –ü–†–û–í–ï–†–ö–ê –ó–ê –ö–†–ê–ï–ù –°–†–û–ö
            if (task.endDate && nextDateStr > task.endDate) {
                if(confirm("–¢–æ–≤–∞ –±–µ—à–µ –ø–æ—Å–ª–µ–¥–Ω–æ—Ç–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ —Å–ø–æ—Ä–µ–¥ –∫—Ä–∞–π–Ω–∏—è —Å—Ä–æ–∫. –î–∞ –ø—Ä–∏–∫–ª—é—á–∞ –ª–∏ –∑–∞–¥–∞—á–∞—Ç–∞?")) {
                    tasks.splice(index, 1);
                }
            } else {
                // –ü—Ä–æ—Å—Ç–æ –º–µ—Å—Ç–∏–º –∑–∞ —Å–ª–µ–¥–≤–∞—â–∏—è –ø—ä—Ç
                task.date = nextDateStr;
                task.notified = false;
                alert(`–ì–æ—Ç–æ–≤–æ! –ü—Ä–µ–º–µ—Å—Ç–µ–Ω–∞ –∑–∞ ${formatDate(task.date)}`);
            }

            saveData();
            render();
        }

        function deleteTask(id) {
            if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) {
                tasks = tasks.filter(t => t.id !== id);
                saveData(); render();
            }
        }

        function checkReminders() {
            const now = new Date();
            const dateStr = now.toISOString().split('T')[0];
            const timeStr = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');

            let changed = false;
            tasks.forEach(t => {
                if (t.date === dateStr && t.time === timeStr && !t.notified) {
                    new Notification("–ù–∞–ø–æ–º–Ω—è–Ω–µ", { body: t.desc, icon: 'https://cdn-icons-png.flaticon.com/512/762/762686.png', vibrate: [500] });
                    document.getElementById('alarmSound').play().catch(()=>{});
                    t.notified = true;
                    changed = true;
                }
            });
            if(changed) saveData();
        }

        // --- 3. UI ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = "";

            tasks.sort((a, b) => a.date.localeCompare(b.date) || (a.time || "").localeCompare(b.time || ""));

            const today = new Date().toISOString().split('T')[0];
            
            // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ
            const overdue = tasks.filter(t => t.date < today);
            const todayList = tasks.filter(t => t.date === today);
            const future = tasks.filter(t => t.date > today);

            if (overdue.length) renderGroup("‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∏", overdue, "overdue");
            renderGroup("üìÖ –î–Ω–µ—Å", todayList, "today");
            renderGroup("üîú –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏", future, "future");

            if(!tasks.length) app.innerHTML = "<div style='text-align:center; color:#444; margin-top:50px;'>–°–ø–∏—Å—ä–∫—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω.</div>";
        }

        function renderGroup(title, list, cls) {
            if (!list.length && cls !== 'today') return;
            app.innerHTML += `<div class="section-title">${title}</div>`;
            app.innerHTML += list.map(t => `
                <div class="task-card ${cls}">
                    <div class="check-circle" onclick="completeTask(${t.id})">‚úî</div>
                    <div class="info">
                        <div class="text">${t.desc}</div>
                        <div class="meta">
                            ${t.time ? `<span>‚è∞ ${t.time}</span>` : ''}
                            <span>üóìÔ∏è ${formatDate(t.date)}</span>
                            ${renderTags(t)}
                        </div>
                    </div>
                    <button class="btn-del" onclick="deleteTask(${t.id})">‚úï</button>
                </div>
            `).join('');
        }

        function renderTags(t) {
            let html = "";
            if (t.repeat !== 'none') {
                let text = (t.repeat === 'custom') ? `${t.customInterval} –¥–Ω–∏` : (t.repeat==='weekly'?'–°–µ–¥–º–∏—á–Ω–æ':'–ï–∂–µ–¥–Ω–µ–≤–Ω–æ');
                html += `<span class="tag">‚Üª ${text}</span>`;
            }
            if (t.endDate) {
                html += `<span class="tag tag-end">üèÅ –î–æ: ${formatDate(t.endDate)}</span>`;
            }
            return html;
        }

        // --- Helpers ---
        function saveData() { localStorage.setItem('tasksV5', JSON.stringify(tasks)); }
        
        function handleRepeatChange() {
            const val = document.getElementById('inpRepeat').value;
            // –ü–æ–∫–∞–∑–≤–∞–º–µ –ø–æ–ª–µ—Ç–æ –∑–∞ –¥–Ω–∏ –∞–∫–æ –µ custom
            document.getElementById('customDaysRow').style.display = (val === 'custom') ? 'block' : 'none';
            // –ü–æ–∫–∞–∑–≤–∞–º–µ –ø–æ–ª–µ—Ç–æ –∑–∞ –ö—Ä–∞–π–Ω–∞ –¥–∞—Ç–∞ –∞–∫–æ –∏–º–∞ –Ω—è–∫–∞–∫–≤–æ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ
            document.getElementById('endDateRow').style.display = (val !== 'none') ? 'block' : 'none';
        }

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function formatDate(d) { return new Date(d).toLocaleDateString('bg-BG', {day:'numeric', month:'short'}); }
    </script>
</body>
</html>
