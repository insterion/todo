<!DOCTYPE html>
<html lang="bg" style="color-scheme: dark;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner V6</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #000; --card: #1c1c1e; --text: #fff; --gray: #2c2c2e; }
        /* –¶–≤–µ—Ç–æ–≤–µ –Ω–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏—Ç–µ */
        .cat-work { --accent: #BB86FC; }   /* –õ–∏–ª–∞–≤–æ */
        .cat-personal { --accent: #03dac6; } /* –¢—é—Ä–∫–æ–∞–∑ */
        .cat-health { --accent: #cf6679; }   /* –ß–µ—Ä–≤–µ–Ω–æ */
        .cat-shopping { --accent: #f9a825; } /* –ñ—ä–ª—Ç–æ */
        .cat-default { --accent: #888; }     /* –°–∏–≤–æ */

        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 20px; padding-bottom: 90px;
        }

        /* –•–µ–¥—ä—Ä –∏ –ü—Ä–æ–≥—Ä–µ—Å */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        h2 { margin: 0; font-weight: 800; background: linear-gradient(90deg, #BB86FC, #03dac6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .progress-container { background: #333; height: 6px; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .progress-bar { height: 100%; background: #03dac6; width: 0%; transition: width 0.5s ease; }
        .progress-text { font-size: 0.8em; color: #aaa; text-align: right; margin-top: -20px; margin-bottom: 20px; display: block;}

        /* –ö–∞—Ä—Ç–∏ */
        .task-card {
            background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 16px;
            display: flex; align-items: center; border-left: 5px solid var(--accent, #888);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s; position: relative;
        }
        .task-card:active { transform: scale(0.98); }
        .task-card.overdue { border-left-color: #ff453a !important; }

        .check-circle {
            min-width: 26px; height: 26px; border: 2px solid var(--accent, #888); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        
        .info { flex-grow: 1; overflow: hidden; }
        .text { font-size: 1.1em; font-weight: 500; margin-bottom: 4px; }
        .meta { font-size: 0.85em; color: #aaa; display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px;}

        .btn-del { background: none; border: none; font-size: 1.2em; color: #666; padding: 10px; }
        .btn-icon { background: none; border: none; font-size: 1.5em; color: #fff; cursor: pointer; }

        /* FAB */
        .fab {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background: linear-gradient(135deg, #BB86FC, #3700B3); color: white; border-radius: 50%; border: none;
            font-size: 30px; box-shadow: 0 4px 20px rgba(100,0,200, 0.4); cursor: pointer; z-index: 100;
        }

        /* –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 200;
        }
        .modal { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; }
        
        input, select {
            width: 100%; padding: 14px; background: var(--gray); border: 1px solid #3a3a3c;
            color: white; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 12px;
        }
        
        .cat-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .cat-opt { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; opacity: 0.5; }
        .cat-opt.selected { border-color: white; opacity: 1; transform: scale(1.1); }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; }
        .btn-save { background: #BB86FC; color: black; padding: 10px 20px; border-radius: 8px; border:none; font-weight: bold;}
        .btn-cancel { background: transparent; color: #aaa; border:none; }

        #customDaysRow, #endDateRow { display: none; }
    </style>
</head>
<body>

    <header>
        <h2>Organizer V6</h2>
        <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    </header>

    <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
    </div>
    <span class="progress-text" id="progressText">0% –∑–∞–≤—ä—Ä—à–µ–Ω–∏ –¥–Ω–µ—Å</span>

    <div id="app"></div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 style="margin-top:0">–ù–æ–≤–∞ –ó–∞–¥–∞—á–∞</h3>
            <input type="text" id="inpDesc" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ...">
            
            <label style="font-size:0.9em; color:#aaa">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <div class="cat-selector" id="catSelector">
                <div class="cat-opt" style="background:#888" onclick="selectCat('cat-default')" data-val="cat-default"></div>
                <div class="cat-opt" style="background:#BB86FC" onclick="selectCat('cat-work')" data-val="cat-work"></div> <div class="cat-opt" style="background:#03dac6" onclick="selectCat('cat-personal')" data-val="cat-personal"></div> <div class="cat-opt" style="background:#cf6679" onclick="selectCat('cat-health')" data-val="cat-health"></div> <div class="cat-opt" style="background:#f9a825" onclick="selectCat('cat-shopping')" data-val="cat-shopping"></div> </div>
            
            <div style="display:flex; gap:10px">
                <input type="date" id="inpDate">
                <input type="time" id="inpTime">
            </div>

            <select id="inpRepeat" onchange="handleRepeatChange()">
                <option value="none">–ï–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ</option>
                <option value="daily">–í—Å–µ–∫–∏ –¥–µ–Ω</option>
                <option value="weekly">–í—Å—è–∫–∞ —Å–µ–¥–º–∏—Ü–∞</option>
                <option value="custom">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–æ</option>
            </select>
            
            <input type="number" id="inpDays" placeholder="–î–Ω–∏..." style="display:none">
            <input type="date" id="inpEndDate" style="display:none; border-color:#ff9f0a" placeholder="–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫">

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">–û—Ç–∫–∞–∑</button>
                <button class="btn-save" onclick="saveTask()">–ó–∞–ø–∞–∑–∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ & –î–∞–Ω–Ω–∏</h3>
            <p style="color:#aaa; font-size:0.9em">–ó–∞–ø–∞–∑–∏ –¥–∞–Ω–Ω–∏—Ç–µ —Å–∏ –≤—ä–≤ —Ñ–∞–π–ª, –∑–∞ –¥–∞ –Ω–µ –≥–∏ –∑–∞–≥—É–±–∏—à.</p>
            
            <button onclick="exportData()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:10px; margin-bottom:10px; text-align:left;">‚¨áÔ∏è –ò–∑—Ç–µ–≥–ª–∏ —Ä–µ–∑–µ—Ä–≤–Ω–æ –∫–æ–ø–∏–µ</button>
            
            <button onclick="document.getElementById('fileInput').click()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:10px; text-align:left;">‚¨ÜÔ∏è –í—ä–∑—Å—Ç–∞–Ω–æ–≤–∏ –æ—Ç —Ñ–∞–π–ª</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)">

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="document.getElementById('settingsModal').style.display='none'">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        let tasks = JSON.parse(localStorage.getItem('tasksV6')) || [];
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç V5 (–∞–∫–æ –∏–º–∞)
        const oldV5 = localStorage.getItem('tasksV5');
        if(oldV5) {
            tasks = JSON.parse(oldV5);
            localStorage.removeItem('tasksV5');
            tasks.forEach(t => t.category = 'cat-default'); // –î–æ–±–∞–≤—è–º–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
            saveData();
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        Notification.requestPermission();
        
        // Init
        document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
        let selectedCategory = 'cat-default';
        selectCat('cat-default');
        
        render();
        setInterval(checkReminders, 5000);

        // --- CORE FUNCTIONS ---

        function saveTask() {
            const desc = document.getElementById('inpDesc').value;
            if(!desc) return alert("–õ–∏–ø—Å–≤–∞ –∑–∞–≥–ª–∞–≤–∏–µ!");

            tasks.push({
                id: Date.now(),
                desc,
                category: selectedCategory,
                date: document.getElementById('inpDate').value,
                time: document.getElementById('inpTime').value,
                repeat: document.getElementById('inpRepeat').value,
                customInterval: parseInt(document.getElementById('inpDays').value) || 0,
                endDate: document.getElementById('inpEndDate').value || null,
                notified: false
            });
            saveData(); closeModal(); render();
        }

        function completeTask(id) {
            const idx = tasks.findIndex(t => t.id === id);
            if(idx === -1) return;
            const t = tasks[idx];

            if(t.repeat === 'none') {
                tasks.splice(idx, 1);
            } else {
                // –ò–∑—á–∏—Å–ª—è–≤–∞–Ω–µ –Ω–∞ —Å–ª–µ–¥–≤–∞—â–∞ –¥–∞—Ç–∞
                let d = new Date(t.date);
                if(t.repeat === 'daily') d.setDate(d.getDate()+1);
                else if(t.repeat === 'weekly') d.setDate(d.getDate()+7);
                else if(t.repeat === 'custom') d.setDate(d.getDate() + t.customInterval);

                const nextStr = d.toISOString().split('T')[0];
                if(t.endDate && nextStr > t.endDate) {
                    if(confirm("–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫ –¥–æ—Å—Ç–∏–≥–Ω–∞—Ç. –î–∞ –ø—Ä–∏–∫–ª—é—á–∞ –ª–∏ –∑–∞–¥–∞—á–∞—Ç–∞?")) tasks.splice(idx, 1);
                } else {
                    t.date = nextStr;
                    t.notified = false;
                }
            }
            saveData(); render();
        }

        function checkReminders() {
            const now = new Date();
            const d = now.toISOString().split('T')[0];
            const t = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            
            let changed = false;
            tasks.forEach(task => {
                if(task.date === d && task.time === t && !task.notified) {
                    new Notification("–ù–∞–ø–æ–º–Ω—è–Ω–µ", { body: task.desc, icon: 'https://cdn-icons-png.flaticon.com/512/762/762686.png', vibrate: [500] });
                    document.getElementById('alarmSound').play().catch(()=>{});
                    task.notified = true;
                    changed = true;
                }
            });
            if(changed) saveData();
        }

        // --- UI & HELPERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = "";
            tasks.sort((a,b) => a.date.localeCompare(b.date) || (a.time||"").localeCompare(b.time||""));

            // –ü—Ä–æ–≥—Ä–µ—Å –±–∞—Ä
            const today = new Date().toISOString().split('T')[0];
            const todayTotal = tasks.filter(t => t.date === today).length;
            // –¢—É–∫ –µ –º–∞–ª–∫–æ —Å–ª–æ–∂–Ω–æ —Å –±—Ä–æ–µ–Ω–µ—Ç–æ –Ω–∞ –∑–∞–≤—ä—Ä—à–µ–Ω–∏, –∑–∞—â–æ—Ç–æ –Ω–∏–µ –≥–∏ –º–µ—Å—Ç–∏–º –≤–µ–¥–Ω–∞–≥–∞.
            // –ó–∞ –æ–ø—Ä–æ—Å—Ç—è–≤–∞–Ω–µ: –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–≤–∞–º–µ –∫–æ–ª–∫–æ –æ—Å—Ç–∞–≤–∞—Ç.

            const overdue = tasks.filter(t => t.date < today);
            const todayList = tasks.filter(t => t.date === today);
            const future = tasks.filter(t => t.date > today);

            if(overdue.length) renderGroup("‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∏", overdue, "overdue");
            renderGroup("üìÖ –î–Ω–µ—Å", todayList, "today");
            renderGroup("üîú –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏", future, "future");

            if(!tasks.length) app.innerHTML = "<div style='text-align:center;color:#444;margin-top:50px'>–°–ø–∏—Å—ä–∫—ä—Ç –µ –ø—Ä–∞–∑–µ–Ω</div>";
        }

        function renderGroup(title, list, cls) {
            if(!list.length && cls!=='today') return;
            app.innerHTML += `<div class="section-title">${title}</div>`;
            app.innerHTML += list.map(t => `
                <div class="task-card ${t.category} ${cls}">
                    <div class="check-circle" onclick="completeTask(${t.id})">‚úî</div>
                    <div class="info">
                        <div class="text">${t.desc}</div>
                        <div class="meta">
                            ${t.time ? `<span>‚è∞ ${t.time}</span>` : ''}
                            <span>üóìÔ∏è ${formatDate(t.date)}</span>
                            ${t.repeat!=='none' ? '<span>‚Üª</span>' : ''}
                            ${t.endDate ? '<span style="color:#ff9f0a">üèÅ</span>' : ''}
                        </div>
                    </div>
                    <button class="btn-del" onclick="deleteTask(${t.id})">‚úï</button>
                </div>
            `).join('');
        }

        function selectCat(cat) {
            selectedCategory = cat;
            document.querySelectorAll('.cat-opt').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-val="${cat}"]`).classList.add('selected');
        }

        function handleRepeatChange() {
            const val = document.getElementById('inpRepeat').value;
            document.getElementById('inpDays').style.display = (val === 'custom') ? 'block' : 'none';
            document.getElementById('inpEndDate').style.display = (val !== 'none') ? 'block' : 'none';
        }

        // Export/Import
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "mytasks_backup.json");
            dlAnchorElem.click();
        }

        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loaded = JSON.parse(e.target.result);
                    if(Array.isArray(loaded)) {
                        tasks = loaded;
                        saveData(); render();
                        alert("–£—Å–ø–µ—à–Ω–æ –≤—ä–∑—Å—Ç–∞–Ω–æ–≤—è–≤–∞–Ω–µ!");
                        document.getElementById('settingsModal').style.display='none';
                    }
                } catch(err) { alert("–ì—Ä–µ—à–∫–∞ –≤—ä–≤ —Ñ–∞–π–ª–∞!"); }
            };
            reader.readAsText(file);
        }

        function saveData() { localStorage.setItem('tasksV6', JSON.stringify(tasks)); }
        function deleteTask(id) { if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) { tasks = tasks.filter(t=>t.id!==id); saveData(); render(); } }
        function openModal() { document.getElementById('modal').style.display='flex'; }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
        function formatDate(d) { return new Date(d).toLocaleDateString('bg-BG', {day:'numeric', month:'short'}); }
    </script>
</body>
</html>
