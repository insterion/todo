<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Planner</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #BB86FC; --bg: #121212; --card: #1e1e1e; --text: #eee; --accent: #03dac6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; padding-bottom: 80px; }
        
        h2 { color: var(--primary); font-weight: 300; margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        /* –°–µ–∫—Ü–∏–∏ */
        .section-title { font-size: 0.9em; color: #888; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; }

        /* –ö–∞—Ä—Ç–∏ */
        .task-card {
            background: var(--card); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; align-items: center; border-left: 4px solid var(--accent);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .task-card.overdue { border-left-color: #ff5555; }
        .task-card.future { border-left-color: #555; opacity: 0.8; }

        .check-circle {
            min-width: 24px; height: 24px; border: 2px solid var(--accent); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        
        .info { flex-grow: 1; }
        .meta { font-size: 0.8em; color: #aaa; display: flex; gap: 10px; }
        .recurrence-badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }

        .btn-del { background: none; border: none; font-size: 1.2em; color: #666; padding: 5px; }

        /* FAB (–ü–ª–∞–≤–∞—â –±—É—Ç–æ–Ω) */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background: var(--primary); color: #000; border-radius: 50%; border: none;
            font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
            display: flex; align-items: center; justify-content: center; z-index: 10;
        }

        /* –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü (Add Task) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 20;
        }
        .modal {
            background: var(--card); padding: 20px; border-radius: 15px; width: 90%; max-width: 400px;
        }
        .modal input, .modal select {
            width: 100%; padding: 12px; margin-bottom: 15px; background: #2c2c2c;
            border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; font-size: 16px;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .btn-save { background: var(--primary); color: #000; padding: 10px 20px; border: none; border-radius: 8px; font-weight: bold; }
        .btn-cancel { background: transparent; color: #aaa; padding: 10px 20px; border: none; }
        
        /* –°–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∫—ä—Å—Ç—ä–º –ø–æ–ª–µ—Ç–æ */
        #customDaysRow { display: none; }
    </style>
</head>
<body>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="app">
        </div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 style="margin-top:0">–ù–æ–≤–∞ –ó–∞–¥–∞—á–∞</h3>
            
            <input type="text" id="inpDesc" placeholder="–ö–∞–∫–≤–æ —â–µ –ø—Ä–∞–≤–∏–º?">
            
            <label>–î–∞—Ç–∞ –∏ –ß–∞—Å:</label>
            <div style="display:flex; gap:5px;">
                <input type="date" id="inpDate">
                <input type="time" id="inpTime">
            </div>

            <label>–ü–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ:</label>
            <select id="inpRepeat" onchange="toggleCustomRepeat()">
                <option value="none">–ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ</option>
                <option value="daily">–í—Å–µ–∫–∏ –¥–µ–Ω</option>
                <option value="weekly">–í—Å—è–∫–∞ —Å–µ–¥–º–∏—Ü–∞</option>
                <option value="monthly">–í—Å–µ–∫–∏ –º–µ—Å–µ—Ü</option>
                <option value="custom">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–æ (–Ω–∞ –¥–Ω–∏)</option>
            </select>

            <div id="customDaysRow">
                <input type="number" id="inpDays" placeholder="–ù–∞ –≤—Å–µ–∫–∏ –∫–æ–ª–∫–æ –¥–Ω–∏?" value="5">
            </div>

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()">–û—Ç–∫–∞–∑</button>
                <button class="btn-save" onclick="saveTask()">–ó–∞–ø–∞–∑–∏</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & INIT ---
        let tasks = JSON.parse(localStorage.getItem('smartTasks')) || [];
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç —Å—Ç–∞—Ä–∏ –≤–µ—Ä—Å–∏–∏ (–∞–∫–æ —Å–µ –Ω–∞–ª–æ–∂–∏, –ø—Ä–æ—Å—Ç–æ —á–∏—Å—Ç–∏–º –∑–∞ –ø–æ-–ª–µ—Å–Ω–æ –ø—Ä–∏ V4)
        if(localStorage.getItem('myTasksV3')) {
            localStorage.removeItem('myTasksV3'); // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä–∞—Ç–∞ –≤–µ—Ä—Å–∏—è
            alert("–í–µ—Ä—Å–∏—è—Ç–∞ –µ –æ–±–Ω–æ–≤–µ–Ω–∞! –°—Ç–∞—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –±—è—Ö–∞ –≤ –Ω–µ—Å—ä–≤–º–µ—Å—Ç–∏–º —Ñ–æ—Ä–º–∞—Ç.");
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        Notification.requestPermission();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ –¥–Ω–µ—à–Ω–∞ –¥–∞—Ç–∞ –ø–æ –ø–æ–¥—Ä–∞–∑–±–∏—Ä–∞–Ω–µ
        const todayStr = new Date().toISOString().split('T')[0];
        document.getElementById('inpDate').value = todayStr;

        render();
        setInterval(checkReminders, 5000);

        // --- 2. LOGIC ---

        function saveTask() {
            const desc = document.getElementById('inpDesc').value;
            const date = document.getElementById('inpDate').value || todayStr;
            const time = document.getElementById('inpTime').value;
            const repeatType = document.getElementById('inpRepeat').value;
            const customDays = document.getElementById('inpDays').value;

            if(!desc) return alert("–¢—Ä—è–±–≤–∞ –æ–ø–∏—Å–∞–Ω–∏–µ!");

            const newTask = {
                id: Date.now(),
                desc,
                date,
                time, // –ú–æ–∂–µ –¥–∞ –µ –ø—Ä–∞–∑–Ω–æ
                repeat: repeatType,
                customInterval: (repeatType === 'custom') ? parseInt(customDays) : 0,
                notified: false
            };

            tasks.push(newTask);
            saveData();
            closeModal();
            render();
        }

        function completeTask(id) {
            const index = tasks.findIndex(t => t.id === id);
            if (index === -1) return;
            
            const task = tasks[index];

            // –ê–∫–æ –µ –ø–æ–≤—Ç–∞—Ä—è—â–∞ —Å–µ –∑–∞–¥–∞—á–∞ - –ø—Ä–µ–Ω–∞—Å—Ä–æ—á–≤–∞–º–µ —è!
            if (task.repeat !== 'none') {
                const nextDate = new Date(task.date);
                
                // –õ–æ–≥–∏–∫–∞ –∑–∞ –¥–æ–±–∞–≤—è–Ω–µ –Ω–∞ –¥–Ω–∏
                if (task.repeat === 'daily') nextDate.setDate(nextDate.getDate() + 1);
                else if (task.repeat === 'weekly') nextDate.setDate(nextDate.getDate() + 7);
                else if (task.repeat === 'monthly') nextDate.setMonth(nextDate.getMonth() + 1);
                else if (task.repeat === 'custom') nextDate.setDate(nextDate.getDate() + task.customInterval);

                // –û–±–Ω–æ–≤—è–≤–∞–º–µ –∑–∞–¥–∞—á–∞—Ç–∞ —Å –Ω–æ–≤–∞—Ç–∞ –¥–∞—Ç–∞
                task.date = nextDate.toISOString().split('T')[0];
                task.notified = false; // –†–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–º–µ –∏–∑–≤–µ—Å—Ç–∏–µ—Ç–æ
                
                alert(`–ó–∞–¥–∞—á–∞—Ç–∞ –µ –∑–∞–≤—ä—Ä—à–µ–Ω–∞! –°–ª–µ–¥–≤–∞—â–∞ –¥–∞—Ç–∞: ${task.date}`);
            } else {
                // –ê–∫–æ –µ –µ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞ - —Ç—Ä–∏–µ–º —è (–∏–ª–∏ –º–æ–∂–µ –¥–∞ —è –º–µ—Å—Ç–∏–º –≤ –∏—Å—Ç–æ—Ä–∏—è)
                tasks.splice(index, 1);
            }

            saveData();
            render();
        }

        function deleteTask(id) {
            if(confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?")) {
                tasks = tasks.filter(t => t.id !== id);
                saveData();
                render();
            }
        }

        function checkReminders() {
            const now = new Date();
            const currentDate = now.toISOString().split('T')[0];
            const currentTime = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');

            let changed = false;

            tasks.forEach(task => {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞: –î–Ω–µ—à–Ω–∞ –¥–∞—Ç–∞ –õ–ò –ï? –ò –í—Ä–µ–º–µ—Ç–æ —Å—ä–≤–ø–∞–¥–∞ –ª–∏? –ò –ù–µ —Å–º–µ –ª–∏ —è –∏–∑–≤–µ—Å—Ç–∏–ª–∏?
                if (task.date === currentDate && task.time === currentTime && !task.notified) {
                    
                    // –ò–∑–≤–µ—Å—Ç–∏–µ
                    if(Notification.permission === 'granted') {
                        navigator.serviceWorker.ready.then(reg => {
                            reg.showNotification('–ù–∞–ø–æ–º–Ω—è–Ω–µ', {
                                body: task.desc,
                                icon: 'https://cdn-icons-png.flaticon.com/512/762/762686.png',
                                vibrate: [500, 200, 500]
                            });
                        });
                    }
                    // –ó–≤—É–∫
                    document.getElementById('alarmSound').play().catch(e=>{});
                    
                    task.notified = true;
                    changed = true;
                }
            });

            if(changed) saveData();
        }

        // --- 3. UI RENDERING ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = ""; // –ß–∏—Å—Ç–∏–º –µ–∫—Ä–∞–Ω–∞

            // –°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –ø–æ –¥–∞—Ç–∞ –∏ —á–∞—Å
            tasks.sort((a, b) => {
                if (a.date !== b.date) return a.date.localeCompare(b.date);
                return (a.time || "00:00").localeCompare(b.time || "00:00");
            });

            // –ì—Ä—É–ø–∏—Ä–∞–Ω–µ
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = tasks.filter(t => t.date === today);
            const futureTasks = tasks.filter(t => t.date > today);
            const overdueTasks = tasks.filter(t => t.date < today);

            // –†–µ–Ω–¥–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ –≥—Ä—É–ø–∏—Ç–µ
            if (overdueTasks.length > 0) renderGroup("‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∏", overdueTasks, "overdue");
            renderGroup("üìÖ –î–Ω–µ—Å", todayTasks, "today");
            renderGroup("üîú –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏", futureTasks, "future");
            
            if (tasks.length === 0) app.innerHTML = "<div style='text-align:center; margin-top:50px; color:#555'>–ù—è–º–∞ –∑–∞–¥–∞—á–∏. –ù–∞—Ç–∏—Å–Ω–∏ + –¥–æ–ª—É –≤–¥—è—Å–Ω–æ!</div>";
        }

        function renderGroup(title, list, className) {
            if (list.length === 0 && className !== 'today') return; // –ù–µ –ø–æ–∫–∞–∑–≤–∞–º–µ –ø—Ä–∞–∑–Ω–∏ –≥—Ä—É–ø–∏ (–æ—Å–≤–µ–Ω –¥–Ω–µ—Å)

            const html = `
                <div class="section-title">${title}</div>
                ${list.map(t => `
                    <div class="task-card ${className}">
                        <div class="check-circle" onclick="completeTask(${t.id})">‚úî</div>
                        <div class="info">
                            <div class="text">${t.desc}</div>
                            <div class="meta">
                                ${t.time ? `<span>‚è∞ ${t.time}</span>` : ''}
                                <span>üóìÔ∏è ${formatDate(t.date)}</span>
                                ${t.repeat !== 'none' ? `<span class="recurrence-badge">‚Üª ${formatRepeat(t)}</span>` : ''}
                            </div>
                        </div>
                        <button class="btn-del" onclick="deleteTask(${t.id})">üóëÔ∏è</button>
                    </div>
                `).join('')}
            `;
            document.getElementById('app').innerHTML += html;
        }

        // --- 4. HELPERS ---
        
        function saveData() {
            localStorage.setItem('smartTasks', JSON.stringify(tasks));
        }

        function toggleCustomRepeat() {
            const val = document.getElementById('inpRepeat').value;
            document.getElementById('customDaysRow').style.display = (val === 'custom') ? 'block' : 'none';
        }

        function openModal() { document.getElementById('modal').style.display = 'flex'; }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function formatDate(dateStr) {
            // –§–æ—Ä–º–∞—Ç–∏—Ä–∞ YYYY-MM-DD –∫—ä–º –ø–æ-—á–µ—Ç–∏–º –≤–∏–¥
            const d = new Date(dateStr);
            return d.toLocaleDateString('bg-BG', { day: 'numeric', month: 'short' });
        }
        
        function formatRepeat(task) {
            if(task.repeat === 'daily') return '–î–Ω.';
            if(task.repeat === 'weekly') return '–°–µ–¥–º.';
            if(task.repeat === 'monthly') return '–ú–µ—Å.';
            if(task.repeat === 'custom') return `${task.customInterval} –¥.`;
            return '';
        }
    </script>
</body>
</html>
