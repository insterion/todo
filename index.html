<!DOCTYPE html>
<html lang="bg" style="color-scheme: dark;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizer V7</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bg: #000; --card: #1c1c1e; --text: #fff; --gray: #2c2c2e; }
        /* –¶–≤–µ—Ç–æ–≤–µ */
        .cat-work { --accent: #BB86FC; }   
        .cat-personal { --accent: #03dac6; } 
        .cat-health { --accent: #cf6679; }   
        .cat-shopping { --accent: #f9a825; } 
        .cat-default { --accent: #888; }     

        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; padding: 20px; padding-bottom: 90px;
        }

        /* –•–µ–¥—ä—Ä */
        header { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; }
        h2 { margin: 0; font-weight: 800; background: linear-gradient(90deg, #BB86FC, #03dac6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* –¢—ä—Ä—Å–∞—á–∫–∞ */
        #searchBar {
            background: #333; border: none; padding: 12px; border-radius: 10px; color: white; width: 100%; box-sizing: border-box; font-size: 16px;
        }

        /* –§–∏–ª—Ç—Ä–∏ (Tabs) */
        .filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
        .filter-chip { 
            background: #333; padding: 6px 12px; border-radius: 20px; font-size: 0.85em; white-space: nowrap; cursor: pointer; border: 1px solid transparent;
        }
        .filter-chip.active { background: #BB86FC; color: black; font-weight: bold; }

        /* –ö–∞—Ä—Ç–∏ */
        .task-card {
            background: var(--card); padding: 16px; margin-bottom: 12px; border-radius: 16px;
            display: flex; align-items: center; border-left: 5px solid var(--accent, #888);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .task-card:active { transform: scale(0.98); }
        .task-card.overdue { border-left-color: #ff453a !important; }

        .check-circle {
            min-width: 26px; height: 26px; border: 2px solid var(--accent, #888); border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        
        .info { flex-grow: 1; overflow: hidden; }
        .text { font-size: 1.1em; font-weight: 500; margin-bottom: 4px; }
        .meta { font-size: 0.85em; color: #aaa; display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; display: flex; align-items: center; gap: 4px;}

        .btn-del { background: none; border: none; font-size: 1.2em; color: #666; padding: 10px; }
        .btn-icon { background: none; border: none; font-size: 1.5em; color: #fff; cursor: pointer; }

        /* FAB */
        .fab {
            position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px;
            background: linear-gradient(135deg, #BB86FC, #3700B3); color: white; border-radius: 50%; border: none;
            font-size: 30px; box-shadow: 0 4px 20px rgba(100,0,200, 0.4); cursor: pointer; z-index: 100;
        }

        /* –ú–æ–¥–∞–ª–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            display: none; align-items: center; justify-content: center; z-index: 200;
        }
        .modal { background: var(--card); padding: 25px; border-radius: 20px; width: 85%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        
        input, select {
            width: 100%; padding: 14px; background: var(--gray); border: 1px solid #3a3a3c;
            color: white; border-radius: 10px; box-sizing: border-box; font-size: 16px; margin-bottom: 12px;
        }
        
        .cat-selector { display: flex; gap: 10px; margin-bottom: 15px; }
        .cat-opt { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; opacity: 0.5; }
        .cat-opt.selected { border-color: white; opacity: 1; transform: scale(1.1); }

        .modal-buttons { display: flex; justify-content: flex-end; gap: 15px; margin-top: 10px; }
        .btn-save { background: #BB86FC; color: black; padding: 10px 20px; border-radius: 8px; border:none; font-weight: bold;}
        
        /* –ò—Å—Ç–æ—Ä–∏—è */
        .history-item { 
            padding: 10px; border-bottom: 1px solid #333; color: #aaa; display: flex; justify-content: space-between; 
        }
        .history-date { font-size: 0.8em; color: #555; }

        #customDaysRow, #endDateRow { display: none; }
    </style>
</head>
<body>

    <header>
        <div class="top-row">
            <h2>Organizer V7</h2>
            <div style="display:flex; gap:10px">
                <button class="btn-icon" onclick="openHistory()">üìú</button>
                <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
        </div>
        
        <input type="text" id="searchBar" placeholder="üîç –¢—ä—Ä—Å–µ–Ω–µ..." oninput="render()">

        <div class="filters">
            <div class="filter-chip active" onclick="setFilter('all', this)">–í—Å–∏—á–∫–∏</div>
            <div class="filter-chip" onclick="setFilter('cat-work', this)">–†–∞–±–æ—Ç–∞</div>
            <div class="filter-chip" onclick="setFilter('cat-personal', this)">–õ–∏—á–Ω–∏</div>
            <div class="filter-chip" onclick="setFilter('cat-health', this)">–ó–¥—Ä–∞–≤–µ</div>
            <div class="filter-chip" onclick="setFilter('cat-shopping', this)">–ü–∞–∑–∞—Ä</div>
        </div>
    </header>

    <div id="app"></div>

    <button class="fab" onclick="openModal()">+</button>

    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 style="margin-top:0">–ù–æ–≤–∞ –ó–∞–¥–∞—á–∞</h3>
            <input type="text" id="inpDesc" placeholder="–ó–∞–≥–ª–∞–≤–∏–µ...">
            
            <label style="font-size:0.9em; color:#aaa">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
            <div class="cat-selector" id="catSelector">
                <div class="cat-opt" style="background:#888" onclick="selectCat('cat-default')" data-val="cat-default"></div>
                <div class="cat-opt" style="background:#BB86FC" onclick="selectCat('cat-work')" data-val="cat-work"></div>
                <div class="cat-opt" style="background:#03dac6" onclick="selectCat('cat-personal')" data-val="cat-personal"></div>
                <div class="cat-opt" style="background:#cf6679" onclick="selectCat('cat-health')" data-val="cat-health"></div>
                <div class="cat-opt" style="background:#f9a825" onclick="selectCat('cat-shopping')" data-val="cat-shopping"></div>
            </div>
            
            <div style="display:flex; gap:10px">
                <input type="date" id="inpDate">
                <input type="time" id="inpTime">
            </div>

            <select id="inpRepeat" onchange="handleRepeatChange()">
                <option value="none">–ï–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ</option>
                <option value="daily">–í—Å–µ–∫–∏ –¥–µ–Ω</option>
                <option value="weekly">–í—Å—è–∫–∞ —Å–µ–¥–º–∏—Ü–∞</option>
                <option value="custom">–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–∞–Ω–æ</option>
            </select>
            
            <input type="number" id="inpDays" placeholder="–î–Ω–∏..." style="display:none">
            <input type="date" id="inpEndDate" style="display:none; border-color:#ff9f0a" placeholder="–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫">

            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeModal()" style="background:none; border:none; color:#aaa">–û—Ç–∫–∞–∑</button>
                <button class="btn-save" onclick="saveTask()">–ó–∞–ø–∞–∑–∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <h3>üìú –ò—Å—Ç–æ—Ä–∏—è (–ó–∞–≤—ä—Ä—à–µ–Ω–∏)</h3>
            <button onclick="clearHistory()" style="background:#333; color:white; border:none; padding:5px 10px; border-radius:5px; margin-bottom:10px;">–ò–∑—á–∏—Å—Ç–∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞</button>
            <div id="historyList"></div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="document.getElementById('historyModal').style.display='none'" style="background:none; border:none; color:#aaa">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <button onclick="exportData()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:10px; margin-bottom:10px; text-align:left;">‚¨áÔ∏è Backup</button>
            <button onclick="document.getElementById('fileInput').click()" style="width:100%; padding:15px; background:#333; color:white; border:none; border-radius:10px; text-align:left;">‚¨ÜÔ∏è Restore</button>
            <input type="file" id="fileInput" style="display:none" onchange="importData(this)">
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="document.getElementById('settingsModal').style.display='none'" style="background:none; border:none; color:#aaa">–ó–∞—Ç–≤–æ—Ä–∏</button>
            </div>
        </div>
    </div>

    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <script>
        let tasks = JSON.parse(localStorage.getItem('tasksV7')) || [];
        // –í–∑–∏–º–∞–º–µ –∏ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞
        let history = JSON.parse(localStorage.getItem('tasksHistory')) || [];
        
        // –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç V6
        const oldV6 = localStorage.getItem('tasksV6');
        if(oldV6) {
            tasks = JSON.parse(oldV6);
            localStorage.removeItem('tasksV6');
            saveData();
        }

        if ('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js');
        Notification.requestPermission();
        
        let currentFilter = 'all';
        let selectedCategory = 'cat-default';
        document.getElementById('inpDate').value = new Date().toISOString().split('T')[0];
        selectCat('cat-default');
        
        render();
        setInterval(checkReminders, 5000);

        // --- CORE FUNCTIONS ---

        function saveTask() {
            const desc = document.getElementById('inpDesc').value;
            if(!desc) return alert("–õ–∏–ø—Å–≤–∞ –∑–∞–≥–ª–∞–≤–∏–µ!");

            tasks.push({
                id: Date.now(),
                desc,
                category: selectedCategory,
                date: document.getElementById('inpDate').value,
                time: document.getElementById('inpTime').value,
                repeat: document.getElementById('inpRepeat').value,
                customInterval: parseInt(document.getElementById('inpDays').value) || 0,
                endDate: document.getElementById('inpEndDate').value || null,
                notified: false
            });
            saveData(); closeModal(); render();
        }

        function completeTask(id) {
            const idx = tasks.findIndex(t => t.id === id);
            if(idx === -1) return;
            const t = tasks[idx];

            // –î–û–ë–ê–í–Ø–ù–ï –í –ò–°–¢–û–†–ò–Ø–¢–ê
            addToHistory(t);

            if(t.repeat === 'none') {
                tasks.splice(idx, 1);
            } else {
                let d = new Date(t.date);
                if(t.repeat === 'daily') d.setDate(d.getDate()+1);
                else if(t.repeat === 'weekly') d.setDate(d.getDate()+7);
                else if(t.repeat === 'custom') d.setDate(d.getDate() + t.customInterval);

                const nextStr = d.toISOString().split('T')[0];
                if(t.endDate && nextStr > t.endDate) {
                    if(confirm("–ö—Ä–∞–µ–Ω —Å—Ä–æ–∫ –¥–æ—Å—Ç–∏–≥–Ω–∞—Ç. –ü—Ä–∏–∫–ª—é—á–≤–∞–Ω–µ?")) tasks.splice(idx, 1);
                } else {
                    t.date = nextStr;
                    t.notified = false;
                }
            }
            saveData(); render();
        }

        function addToHistory(task) {
            const now = new Date();
            history.unshift({
                desc: task.desc,
                completedAt: now.toLocaleDateString('bg-BG') + ' ' + now.toLocaleTimeString('bg-BG')
            });
            // –ü–∞–∑–∏–º —Å–∞–º–æ –ø–æ—Å–ª–µ–¥–Ω–∏—Ç–µ 50 –∑–∞–ø–∏—Å–∞
            if(history.length > 50) history.pop();
            localStorage.setItem('tasksHistory', JSON.stringify(history));
        }

        function checkReminders() {
            const now = new Date();
            const d = now.toISOString().split('T')[0];
            const t = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            
            let changed = false;
            tasks.forEach(task => {
                if(task.date === d && task.time === t && !task.notified) {
                    new Notification("–ù–∞–ø–æ–º–Ω—è–Ω–µ", { body: task.desc, icon: 'https://cdn-icons-png.flaticon.com/512/762/762686.png', vibrate: [500] });
                    document.getElementById('alarmSound').play().catch(()=>{});
                    task.notified = true;
                    changed = true;
                }
            });
            if(changed) saveData();
        }

        // --- UI & HELPERS ---

        function render() {
            const app = document.getElementById('app');
            app.innerHTML = "";
            const searchQuery = document.getElementById('searchBar').value.toLowerCase();

            // –§–∏–ª—Ç—Ä–∏—Ä–∞–Ω–µ
            let filtered = tasks.filter(t => {
                const matchesSearch = t.desc.toLowerCase().includes(searchQuery);
                const matchesCat = (currentFilter === 'all') ? true : (t.category === currentFilter);
                return matchesSearch && matchesCat;
            });

            filtered.sort((a,b) => a.date.localeCompare(b.date) || (a.time||"").localeCompare(b.time||""));

            const today = new Date().toISOString().split('T')[0];
            const overdue = filtered.filter(t => t.date < today);
            const todayList = filtered.filter(t => t.date === today);
            const future = filtered.filter(t => t.date > today);

            if(overdue.length) renderGroup("‚ö†Ô∏è –ü—Ä–æ–ø—É—Å–Ω–∞—Ç–∏", overdue, "overdue");
            renderGroup("üìÖ –î–Ω–µ—Å", todayList, "today");
            renderGroup("üîú –ü—Ä–µ–¥—Å—Ç–æ—è—â–∏", future, "future");

            if(!filtered.length) app.innerHTML = "<div style='text-align:center;color:#444;margin-top:50px'>–ù—è–º–∞ –Ω–∞–º–µ—Ä–µ–Ω–∏ –∑–∞–¥–∞—á–∏</div>";
        }

        function renderGroup(title, list, cls) {
            if(!list.length && cls!=='today') return;
            app.innerHTML += `<div class="section-title">${title}</div>`;
            app.innerHTML += list.map(t => `
                <div class="task-card ${t.category} ${cls}">
                    <div class="check-circle" onclick="completeTask(${t.id})">‚úî</div>
                    <div class="info">
                        <div class="text">${t.desc}</div>
                        <div class="meta">
                            ${t.time ? `<span>‚è∞ ${t.time}</span>` : ''}
                            <span>üóìÔ∏è ${formatDate(t.date)}</span>
                            ${t.repeat!=='none' ? '<span>‚Üª</span>' : ''}
                        </div>
                    </div>
                    <button class="btn-del" onclick="deleteTask(${t.id})">‚úï</button>
                </div>
            `).join('');
        }

        function openHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = history.length === 0 ? "–ù—è–º–∞ –∏–∑–ø—ä–ª–Ω–µ–Ω–∏ –∑–∞–¥–∞—á–∏" : 
                history.map(h => `
                    <div class="history-item">
                        <span>${h.desc}</span>
                        <span class="history-date">${h.completedAt}</span>
                    </div>
                `).join('');
            document.getElementById('historyModal').style.display='flex';
        }

        function clearHistory() {
            if(confirm("–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?")) {
                history = [];
                localStorage.setItem('tasksHistory', JSON.stringify(history));
                openHistory();
            }
        }

        function setFilter(cat, elem) {
            currentFilter = cat;
            document.querySelectorAll('.filter-chip').forEach(el => el.classList.remove('active'));
            elem.classList.add('active');
            render();
        }

        function selectCat(cat) {
            selectedCategory = cat;
            document.querySelectorAll('.cat-opt').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-val="${cat}"]`).classList.add('selected');
        }

        function handleRepeatChange() {
            const val = document.getElementById('inpRepeat').value;
            document.getElementById('inpDays').style.display = (val === 'custom') ? 'block' : 'none';
            document.getElementById('inpEndDate').style.display = (val !== 'none') ? 'block' : 'none';
        }

        // Export/Import (–ë–µ–∑ –ø—Ä–æ–º—è–Ω–∞)
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(tasks));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", "mytasks_backup.json");
            dlAnchorElem.click();
        }
        function importData(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                tasks = JSON.parse(e.target.result); saveData(); render(); alert("–ì–æ—Ç–æ–≤–æ!");
            };
            reader.readAsText(file);
        }

        function saveData() { localStorage.setItem('tasksV7', JSON.stringify(tasks)); }
        function deleteTask(id) { if(confirm("–ò–∑—Ç—Ä–∏–≤–∞–Ω–µ?")) { tasks = tasks.filter(t=>t.id!==id); saveData(); render(); } }
        function openModal() { document.getElementById('modal').style.display='flex'; }
        function closeModal() { document.getElementById('modal').style.display='none'; }
        function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
        function formatDate(d) { return new Date(d).toLocaleDateString('bg-BG', {day:'numeric', month:'short'}); }
    </script>
</body>
</html>
